<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <meta name="theme-color" content="#ffffff" />

  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />

  <title>Blue Team</title>
  <script src="/js/socket.io.min.js" integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI"
    crossorigin="anonymous"></script>
</head>

<body>
  <!-- Box shown when starting a new session -->
  <div id="centerbox" class="center">
    <span class="title" style="color: #626262;">black<span style="color: #e5e5e5; font-weight: normal; font-family: 'Noto Sans Mono', monospace;"><span style="color: #74c7ec">~</span><span style="color: #a6e3a1">$</span> cat<span class="blink">_</span></span></span>
    <div class="inputs">
      <label for="playerName">Player Name:</label>
      <span><input id="playerName"></input></span>
      <label for="roomCode">Game Code:</label>
      <span><input id="roomCode"></input></span>
    </div>
    <div class="buttons">
      <div class="buttongroup" id="gamestart">
        <button style="background-color:#fab387;color:#313244;" onclick="host()">Host</button>
        <button style="background-color:#a6e3a1;color:#313244;" onclick="join()">Join</button>
      </div>
      <div style="display: flex;justify-content: space-between;" id="classselect">
        <button id="scout" onclick="classChange('Scout')">Scout</button>
        <button id="antivirus" onclick="classChange('Antivirus')">Antivirus</button>
        <button id="firewall" onclick="classChange('Firewall')">Firewall</button>
      </div>
      <div class="buttongroup" id="readyup">
        <button id="ready" onclick="ready()">Ready</button>
      </div>
    </div>
    <label for="playerList">Players:</label>
    <ul id="playerList">
    </ul>
    <label for="playerClass">Your Class: </label>
    <p id="playerClass"></p>
    <br>
    <p id="readiness"></p>
    <br>
    <button id="start" style="display: none" onclick="start()">Start</button>
  </div>

  <!-- Box shown after the game has begun -->
  <div id="game" style="display:none;">
    <p id="status"></p>
    <label for="playerGameClass">Class: </label>
    <p id="playerGameClass"></p>
    <button style="display:none;" id="move" onclick="move()">Move</button>
    <button style="display:none;" id="detect" onclick="action('detect')">Detect</button>
    <button style="display:none;" id="disinfect" onclick="action('disinfect')">Disinfect</button>
    <button style="display:none;" id="purge" onclick="action('purge')">Purge</button>
    <button style="display:none;" id="smash" onclick="smash()">Smash</button>
    <ol id="files">
    </ol>
  </div>
</body>

</html>

<script>
  const socket = io();

  function start() {
    socket.emit('start', document.getElementById('roomCode').value)
  }

  function action(action) {
    // Get a reference to all elements with the class "files"
    var files = document.getElementsByClassName('files');

    // Loop through the elements and add an event listener to each one
    for (var i = 0; i < files.length; i++) {
      files[i].addEventListener('click', (e) => {
        // When the event is triggered, retrieve the value of the element and send it as the file ID
        socket.emit('action', document.getElementById('roomCode').value, action, e.target.id)
        // Loop through the elements again and remove the event listener from each one
        for (var j = 0; j < files.length; j++) {
          files[j].removeEventListener('click', this);
        }
      });
    }
  }

  function move() {
    socket.emit('move', document.getElementById('roomCode').value)
  }

  function smash() {
    //TODO: Implement checking the user input
    socket.emit('smash', document.getElementById('roomCode').value, prompt("Player X Position", "A-J"), prompt("Player Y Position", "1-9"))
  }

  socket.on('file', function (files) {
    // Wipe previous file info
    document.getElementById('files').innerHTML = ''
    // Fill with every file
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      document.getElementById('files').innerHTML +=
        `<ul class="files" id=${file.id}>
      <li id=${file.id}> File: ${file.id} </li>
      <li id=${file.id}> X: ${file.x} </li>
      <li id=${file.id}> Y: ${file.y} </li>
      <li id=${file.id}> Good Data: ${file.goodData} </li>
      <li id=${file.id}> Bad Data: ${file.badData} </li>
      </ul>`
        ;
    }
  })

  socket.on('start', function (start) {
    document.getElementById('centerbox').style.display = 'none'
    switch (document.getElementById('playerClass').innerText) {
      case 'Scout':
        document.getElementById('detect').style.display = 'inline'
        break
      case 'Antivirus':
        document.getElementById('disinfect').style.display = 'inline'
        break
      case 'Firewall':
        document.getElementById('purge').style.display = 'inline'
        document.getElementById('smash').style.display = 'inline'
        break
    }
  })

  function host() {
    socket.emit('host', document.getElementById('playerName').value)
  }

  function join() {
    socket.emit('join', document.getElementById('roomCode').value, document.getElementById('playerName').value)
  }

  function classChange(playerClass) {
    socket.emit('class', document.getElementById('roomCode').value, playerClass)
  }

  function ready() {
    socket.emit('ready', document.getElementById('roomCode').value)
  }

  socket.on('code', function (roomCode) {
    document.getElementById('roomCode').value = roomCode
  })

  socket.on('class', function (playerClass) {
    document.getElementById('playerClass').innerText = playerClass
    document.getElementById('playerGameClass').innerText = playerClass
  })

  socket.on('error', function (error) {
    document.getElementById('error').innerHTML = error
    document.getElementById('status').innerHTML = error
  })

  socket.on('success', function (message) {
    document.getElementById('status').innerHTML = message
  })

  socket.on('ready', function (ready) {
    // Updates readiness
    if (ready) {
      document.getElementById('ready').innerText = 'Cancel'
      return
    }
    document.getElementById('ready').innerText = 'Ready'
  })

  socket.on('startAllowed', function (id) {
    if (id === socket.id) {
      document.getElementById('start').style.display = 'inline'
    }
    else {
      document.getElementById('start').style.display = 'none'
    }
  })

  socket.on('players', function (playerData) {
    //Reset Error
    document.getElementById('error').innerHTML = ''

    // Update roles that user can pick
    if (playerData.some((player) => player.class === 'Scout')) {
      document.getElementById('scout').style.display = 'none'
    } else {
      document.getElementById('scout').style.display = 'inline'
    }
    if (playerData.some((player) => player.class === 'Antivirus')) {
      document.getElementById('antivirus').style.display = 'none'
    } else {
      document.getElementById('antivirus').style.display = 'inline'
    }
    if (playerData.some((player) => player.class === 'Firewall')) {
      document.getElementById('firewall').style.display = 'none'
    } else {
      document.getElementById('firewall').style.display = 'inline'
    }

    // Update player list
    document.getElementById('playerList').innerHTML = ''; // Clear existing list
    for (var i = 0; i < playerData.length; i++) {
      var player = playerData[i];
      document.getElementById('playerList').innerHTML += '<li>' + player.name + '</li>';
    }

    // Update readiness of players
    document.getElementById('readiness').innerText = playerData.filter((player) => player.ready === true).length + '/' + playerData.length + ' players ready'
    if (playerData.length < 3) {
      document.getElementById('readiness').innerText += ` Still need ${3 - playerData.length} more player`
      if (3 - playerData.length > 1) {
        document.getElementById('readiness').innerText += 's'
      }
    }
  })
</script>
