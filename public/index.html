<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <meta name="theme-color" content="#ffffff" />

  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />

  <title>Blue Team</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"
    integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI"
    crossorigin="anonymous"></script>
</head>

<body>
  <div id="centerbox">
    <span style="font-size: 60pt;" class="neontext">Blue Team</span>
    <p style="font-size: 24pt;text-align: center;animation: flicker 1s infinite alternate;" class="neontext">- the
      game
      -</p>
    <br>
    <p id="error"></p>
    <div class="inputs">
      <label for="playerName">Name:</label>
      <input id="playerName"></input>
      <label for="roomCode">Code:</label>
      <input id="roomCode"></input>
    </div>
    <button onclick="host()">Host</button>
    <button onclick="join()">Join</button>
    <br>
    <button id="scout" onclick="classChange('Scout')">Scout</button>
    <button id="antivirus" onclick="classChange('Antivirus')">Antivirus</button>
    <button id="firewall" onclick="classChange('Firewall')">Firewall</button>
    <br>
    <button id="ready" onclick="ready()">Ready</button>
    <br>
    <label for="playerList">Players:</label>
    <ul id="playerList">
    </ul>
    <label for="playerClass">Class: </label>
    <p id="playerClass"></p>
    <br>
    <p id="readiness"></p>
    <br>
    <button id="start" style="display: none" onclick="start()">Start</button>
  </div>
  <div id="game">
    <p id="status"></p>
    <label for="playerGameClass">Class: </label>
    <p id="playerGameClass"></p>
    <button id="move" onclick="action('move')">Move</button>
    <button id="detect" onclick="action('detect')">Detect</button>
    <button id="disinfect" onclick="action('disinfect')">Disinfect</button>
    <button id="purge" onclick="action('purge')">Purge</button>
    <button id="smash" onclick="action('smash')">Smash</button>
    <ol id="files">
    </ol>
  </div>
</body>

</html>

<script>
  const socket = io();

  function start() {
    socket.emit('start', document.getElementById('roomCode').value)
  }
  function action(action) {
    socket.emit('action', document.getElementById('roomCode').value, action, 1)
  }

  socket.on('file', function (files) {
    // Wipe previous file info
    document.getElementById('files').innerHTML = ''
    // Fill with every file
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      document.getElementById('files').innerHTML +=
        `<ul>
      <li> File: ${file.id} </li>
      <li> X: ${file.x} </li>
      <li> Y: ${file.y} </li>
      <li> Good Data: ${file.goodData} </li>
      <li> Bad Data: ${file.badData} </li>
      </ul>`
        ;
    }
  })

  socket.on('start', function (start) {
    document.getElementById('centerbox').style.display = 'none'
  })

  function host() {
    socket.emit('host', document.getElementById('playerName').value)
  }

  function join() {
    socket.emit('join', document.getElementById('roomCode').value, document.getElementById('playerName').value)
  }

  function classChange(playerClass) {
    socket.emit('class', document.getElementById('roomCode').value, playerClass)
  }

  function ready() {
    socket.emit('ready', document.getElementById('roomCode').value)
  }

  socket.on('code', function (roomCode) {
    document.getElementById('roomCode').value = roomCode
  })

  socket.on('class', function (playerClass) {
    document.getElementById('playerClass').innerText = playerClass
    document.getElementById('playerGameClass').innerText = playerClass
  })

  socket.on('error', function (error) {
    document.getElementById('error').innerHTML = error
    document.getElementById('status').innerHTML = error
  })

  socket.on('success', function (message) {
    document.getElementById('status').innerHTML = message
  })

  socket.on('ready', function (ready) {
    // Updates readiness
    if (ready) {
      document.getElementById('ready').innerText = 'Cancel'
      return
    }
    document.getElementById('ready').innerText = 'Ready'
  })

  socket.on('startAllowed', function (id) {
    if (id === socket.id) {
      document.getElementById('start').style.display = 'inline'
    }
    else {
      document.getElementById('start').style.display = 'none'
    }
  })

  socket.on('players', function (playerData) {
    //Reset Error
    document.getElementById('error').innerHTML = ''

    // Update roles that user can pick
    if (playerData.some((player) => player.class === 'Scout')) {
      document.getElementById('scout').style.display = 'none'
    } else {
      document.getElementById('scout').style.display = 'inline'
    }
    if (playerData.some((player) => player.class === 'Antivirus')) {
      document.getElementById('antivirus').style.display = 'none'
    } else {
      document.getElementById('antivirus').style.display = 'inline'
    }
    if (playerData.some((player) => player.class === 'Firewall')) {
      document.getElementById('firewall').style.display = 'none'
    } else {
      document.getElementById('firewall').style.display = 'inline'
    }

    // Update player list
    document.getElementById('playerList').innerHTML = ''; // Clear existing list
    for (var i = 0; i < playerData.length; i++) {
      var player = playerData[i];
      document.getElementById('playerList').innerHTML += '<li>' + player.name + '</li>';
    }

    // Update readiness of players
    document.getElementById('readiness').innerText = playerData.filter((player) => player.ready === true).length + '/' + playerData.length + ' players ready'
    if (playerData.length < 3) {
      document.getElementById('readiness').innerText += ` Still need ${3 - playerData.length} more player`
      if (3 - playerData.length > 1) {
        document.getElementById('readiness').innerText += 's'
      }
    }
  })
</script>