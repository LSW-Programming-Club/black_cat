<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <meta name="theme-color" content="#ffffff" />

  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />

  <title>Blue Team</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"
    integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI"
    crossorigin="anonymous"></script>
</head>

<body>
  <div class="centerbox">
    <span style="font-size: 60pt;" class="neontext">Blue Team</span>
    <p style="font-size: 24pt;text-align: center;animation: flicker 1s infinite alternate;" class="neontext">- the game
      -</p>
    <br>
    <div class="inputs">
      <label for="name">Name:</label>
      <input id="name"></input>
      <label for="roomCode">Code:</label>
      <input id="roomCode"></input>
    </div>
    <button onclick="host()">Host</button>
    <button onclick="join()">Join</button>
    <br>
    <button id="scout" onclick="build('Scout')">Scout</button>
    <button id="antivirus" onclick="build('Antivirus')">Antivirus</button>
    <button id="firewall" onclick="build('Firewall')">Firewall</button>
    <br>
    <button id="ready" onclick="ready()">Ready</button>
    <br>
    <label for="playerList">Players:</label>
    <ul id="playerList">
    </ul>
    <p id="build">Class: </p>
    <br>
    <p id="readiness"></p>
    <br>
    <button id="start" style="display: none">Start</button>
  </div>

  <input style="display:none" id="id"></input> <!-- Will be moved to game page -->
</body>

</html>

<script>
  const socket = io();
  function host() {
    socket.emit('host', document.getElementById('name').value)
  }

  function join() {
    var req = {
      name: document.getElementById('name').value,
      code: document.getElementById('roomCode').value
    }
    socket.emit('join', req)
  }

  function build(build) {
    var req = {
      id: document.getElementById('id').value,
      code: document.getElementById('roomCode').value,
      build: build
    }
    socket.emit('build', req)
  }

  function ready() {
    var req = {
      id: document.getElementById('id').value,
      code: document.getElementById('roomCode').value
    }
    socket.emit('ready', req)
  }

  socket.on('success', function (data) {
    document.getElementById('roomCode').value = data
  })

  socket.on('error', function (data) {
    console.log(data)
  })

  socket.on('players', function (data) {
    // Update roles that user can pick
    if (data.some((player) => player.build === 'Scout')) {
      document.getElementById('scout').style.display = 'none'
    } else {
      document.getElementById('scout').style.display = 'inline'
    }
    if (data.some((player) => player.build === 'Antivirus')) {
      document.getElementById('antivirus').style.display = 'none'
    } else {
      document.getElementById('antivirus').style.display = 'inline'
    }
    if (data.some((player) => player.build === 'Firewall')) {
      document.getElementById('firewall').style.display = 'none'
    } else {
      document.getElementById('firewall').style.display = 'inline'
    }

    // Update player list
    var playerListElement = document.getElementById('playerList');
    playerListElement.innerHTML = ''; // Clear existing list
    for (var i = 0; i < data.length; i++) {
      var player = data[i];
      playerListElement.innerHTML += '<li>' + player.name + '</li>';
    }

    // Update readiness of players
    const readyMessage = document.getElementById('readiness')
    readyMessage.innerText = data.filter((player) => player.ready === true).length + '/' + data.length + ' players ready'
    if (data.length < 3) {
      readyMessage.innerText += ` Still need ${3 - data.length} more player`
      if (3 - data.length > 1) {
        readyMessage.innerText += 's'
      }
    }
  })

  socket.on('ready', function (ready) {
    // Updates readiness
    if (ready) {
      document.getElementById('ready').innerText = 'Cancel'
      return
    }
    document.getElementById('ready').innerText = 'Ready'
  })

  socket.on('startAllowed', function (id) {
    if (id === document.getElementById('id').value) {
      document.getElementById('start').style.display = 'inline'
    }
    else {
      document.getElementById('start').style.display = 'none'
    }
  })

  socket.on('build', function (build) {
    document.getElementById('build').innerText = 'Class: ' + build
  })

  socket.on('id', function (id) {
    document.getElementById('id').value = id
  })
</script>